!function(e,t){var a;let s={on(e,a,s){t(document).on(a,e,s)},each(e,a){t(e).each(a)}};class r{constructor(){this.state={auto:!1,open:!1};let e=localStorage.getItem("sidebarState");if(e)try{this.state=JSON.parse(e)}catch(t){console.error("Error parsing stored sidebar state:",t)}this.updateSidebarState()}updateSidebarState(){t("html").addClass("sidebar-close"),this.state.auto&&this.state.open&&t("html").removeClass("sidebar-close")}toggleSidebar(){this.state.auto=!this.state.auto,this.state.open=!this.state.open,localStorage.setItem("sidebarState",JSON.stringify(this.state)),this.updateSidebarState()}handleSidebarHover(e){this.state.auto&&t("html").toggleClass("sidebar-close",!e)}make_element_active(e,a){t("#sidebar a").removeClass("fs-nav-active"),t(e).addClass("fs-nav-active")}}let i=new r;s.on("#sidebar a","click",e=>i.make_element_active(this,e)),s.on("#sidebar .toggle","click",()=>i.toggleSidebar()),s.on("#sidebar","mouseenter",()=>i.handleSidebarHover(!0)),s.on("#sidebar","mouseleave",()=>i.handleSidebarHover(!1)),s.each(".sidebar-icon-link .arrow",function(e){t(this).on("click",function(){e!==a&&t(".nav-links li").removeClass("showMenu"),t(this).parent().parent().toggleClass("showMenu"),a=e})}),e.toastr.options={closeButton:!0,debug:!1,newestOnTop:!0,progressBar:!0,positionClass:"toast-top-right",preventDuplicates:!1,onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"1000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},e.EG={SideBar:r,EGTable:class e{constructor(e){this.page=e.page||"",this.api=e.api||"",this.tabIndex=0,this.store=new Map,this.callbackQueue=[],this.tuiConfig={el:document.getElementById("grid"),bodyHeight:"fitToParent",columns:[],data:[],...e.tuiConfig},this.GRID=new tui.Grid(this.tuiConfig),this.applyGridTheme(e.gridTheme),this.dateRange=e.dateRange||"ds=2023-01-01&de=2023-12-31",this.start(),this.bindEvents()}generateKey(e){if("boolean"==typeof e||null==e)throw Error("Invalid input: Boolean, null, or undefined values are not allowed.");let t=JSON.stringify(e),a=0;for(let s=0;s<t.length;s++){let r=t.charCodeAt(s);a=(a<<5)-a+r,a&=a}return(a>>>0).toString(36)}setState(e,t){let a="object"==typeof t&&null!==t,s=a?Array.isArray(t)?[...t]:{...t}:t;this.store.set(this.generateKey(e),{startValue:a?Array.isArray(s)?[...s]:{...s}:s,prevValue:null,value:s,lastValidValue:null,isValid:!1,errorMessage:""})}logState(e){let t=new Map([...this.store]),a=Error(),s=a.stack.split("\n")[2].trim();console.log(`${e||"Log State: no msg provided"}
${s}`),console.log(t)}getStateValidity(e){let t=this.store.get(this.generateKey(e));return t?{isValid:t.isValid,errorMessage:t.errorMessage,lastValidValue:t.lastValidValue,value:t.value}:null}updateState(e,t,a=!0){let s=this.store.get(this.generateKey(e));if(s){if(!a)return s.prevValue=s.value,s.value=t,this.store.set(this.generateKey(e),{...s}),{...s};let r=(a,r)=>{let i=()=>{s.isValid=a,s.errorMessage=a?"":r||"Validation failed.",s.prevValue=s.value,s.value=t,a&&(s.lastValidValue=t),this.store.set(this.generateKey(e),{...s})};return this.callbackQueue.push(i),this.processQueue(),{...s}};return r}return null}processQueue(){for(;this.callbackQueue.length>0;){let e=this.callbackQueue.shift();try{e()}catch(t){console.error("Error in callback:",t)}}}destroyState(e){this.store.delete(this.generateKey(e))}readState(e){let t=this.store.get(this.generateKey(e));return t?{...t}:null}urlBuilder(e="",t=[]){var a="";return t.length>0&&t.forEach(e=>{a=a+"&"+e}),this.api+"?ep="+e+a}loadStateFromLocalStorage(){let e=localStorage.getItem(`${this.page}AppState`);if(e){let t=JSON.parse(e);this.tabIndex=t.tabIndex||0,this.dateRange=t.dateRange||this.dateRange}}saveStateToLocalStorage(){let e={tabIndex:this.tabIndex,dateRange:this.dateRange};localStorage.setItem(`${this.page}AppState`,JSON.stringify(e))}setActiveTab(e=!1){t("#myTab button").removeClass("active"),e?e.addClass("active"):t(`#myTab button[data-index='${this.tabIndex}']`).addClass("active")}async ajax(e,a="GET",s={}){try{let r=await t.ajax({type:a,url:e,data:s});if("success"!==r.status)throw Error(r.message);return r.data}catch(i){throw Error(i.statusText||i.responseText||i)}}addNav(){t("#myTab").empty();let e=this.readState("tables").value;e.forEach((e,a)=>{var s=t("<li/>").addClass("nav-item"),r=t("<button/>").attr({id:e.name+"_tab","data-index":a,type:"button",role:"tab"}).addClass(`nav-link ${0===a?"active":""}`).text(e.display_name);s.append(r),t("#myTab").append(s)})}applyGridTheme(e){window.tui.Grid.applyTheme("default",e||{outline:{border:"rgb(217, 224, 232)"},area:{header:{border:"rgb(217, 224, 232)"}},cell:{header:{border:"rgb(217, 224, 232)",showVerticalBorder:!1}}})}async start(){try{var e=this.urlBuilder("pageTables",["page="+this.page]);let t=await this.ajax(e);this.setState("tables",[...t]);let a=this.readState("tables"),s=await this.checkFormattors(a);this.updateState("tables",s,!1),this.addNav(),this.loadStateFromLocalStorage(),this.setTable()}catch(r){console.log(r)}}setTable(){let e=this.readState("tables");this.GRID.setColumns(e.value[this.tabIndex].columns),this.setTableData(),this.setModal(),this.setActiveTab()}setModal(){var e=this;try{var a=e.tabIndex;let s=e.readState("tables").value,r="includes/modal_api.php?modal="+s[a].modal,i=e.readState("modaeInputs");if(i){for(;i.value.length>0;)e.destroyState(i.value.shift()+"FormInput",value);e.destroyState("modaeInputs")}var l=[];t.get(r).then(a=>{t("#modal_go_here").empty().append(a).find("input").each(function(){e.setState(t(this).attr("name")+"FormInput",""),l.push(t(this).attr("name"))}),e.setState("modaeInputs",l)}).catch(e=>{throw Error(e)})}catch(o){console.log(o)}}async setTableData(){var e=this.tabIndex;let t=this.readState("tables").value,a=this.urlBuilder("get_table",["table="+t[e].name,this.dateRange]);try{let s=await this.ajax(a);this.GRID.resetData(s)}catch(r){console.log(r),this.GRID.resetData([])}}async checkFormattors(e){for(let t of e.value)for(let a of t.columns)if(a.hasOwnProperty("formatter")){var s=Object.keys(a.formatter)[0],r=Object.values(a.formatter)[0],i=this.urlBuilder("getIdVal",["table="+s,"column="+r]);try{let l=await this.ajax(i);this.setState(t.name+"Formatter",[...l]),a.formatter=e=>{let a=this.readState(t.name+"Formatter");var s=a.value.find(t=>t.id===parseInt(e.value));return s?s[r]:e.value}}catch(o){console.log(o)}}return e.value}on(e,a,s){t(document).on(e,a,s)}each(e,a){t(e).each(a)}validateField(e){var a=e.val().trim(),s=e.attr("name"),r=this.updateState(s+"FormInput",a);let i=this.readState("tables").value,l=this.urlBuilder("validate_field",["table="+i[this.tabIndex].name]);t.ajax({type:"POST",url:l,data:{fieldName:s,value:a},success:function(t){var a=r(t.data.isValid,t.data.message);a.isValid?e.removeClass("is-invalid").addClass("is-valid").siblings(".error-message").text(a.errorMessage):e.removeClass("is-valid").addClass("is-invalid").siblings(".error-message").text(a.errorMessage)},error:function(e){console.error(e)}})}validateForm(){var e=this,a=!0;return t("#form_new_record input").each(function(){e.validateField(t(this)),""!==t(this).siblings(".error-message").text()&&(a=!1)}),a}sendDataToServer(){var e=this,a=t("#form_new_record").serializeArray(),s={};t.each(a,function(e,t){s[t.name]=t.value});let r=e.readState("tables").value,i=e.urlBuilder("new_row",["table="+r[e.tabIndex].name]);t.ajax({type:"POST",url:i,data:s,success:function(a){console.log(a),"success"===a.status&&(e.GRID.appendRow(a.data),toastr.info(a.status,"Added successfuly!"),t("#modal_go_here").find(".btn-close").click(),t("#modal_go_here").find("input").each(function(e){console.log(t(this)),t(this).val("").removeClass(["is-valid","is-invalid"]).siblings(".error-message").text("")}))},error:function(e){console.error(e)}})}bindEvents(){var e=this;e.on("click","#myTab button",function(){e.tabIndex=t(this).attr("data-index"),e.setActiveTab(t(this)),e.setTable()}),e.on("click","#clear_Filetrs",()=>{let t=e.readState("tables").value;t[e.tabIndex].columns.forEach(t=>{e.GRID.unfilter(t.name)})}),e.GRID.on("editingStart",function(t){var{columnName:a,rowKey:s,value:r}=t;e.setState({columnName:a,rowKey:s},r)}),e.GRID.on("beforeChange",function(t){var{columnName:a,rowKey:s}=t.changes[0],r=e.getStateValidity({columnName:a,rowKey:s});r&&!r.isValid&&(t.stop(),e.destroyState({columnName:a,rowKey:s}),toastr.error(r.errorMessage,"Validation Error!"))}),e.GRID.on("afterChange",function(t){var{columnName:a,rowKey:s}=t.changes[0],r=e.GRID.getRow(s);let i=e.readState("tables").value;var l=e.getStateValidity({columnName:a,rowKey:s});if(l&&l.isValid){try{let o=e.urlBuilder("update_table",["table="+i[e.tabIndex].name]),n=e.ajax(o,"POST",{fieldName:a,value:l.nextValue,id:r.id});n&&(window.toastr.info("Success"),e.destroyState({columnName:a,rowKey:s}))}catch(d){onsole.error(d)}e.destroyState({columnName:a,rowKey:s})}}),e.on("input","#grid input.tui-grid-content-text",function(a){var{columnName:s,rowKey:r}=e.GRID.getFocusedCell(),i=t(this),l=e.updateState({columnName:s,rowKey:r},a.target.value);let o=e.readState("tables").value,n=e.urlBuilder("validate_field",["table="+o[e.tabIndex].name]);t.ajax({type:"POST",url:n,data:{fieldName:s,value:a.target.value},success:function(e){var t=l(e.data.isValid,e.data.message);t.isValid?i.css({borderColor:"#71dd37"}).removeAttr("data-mdb-tooltip-init").removeAttr("data-mdb-ripple-init").removeAttr("data-mdb-placement").removeAttr("title"):i.css({borderColor:"#ff3e1d"}).attr({"data-mdb-tooltip-init":"","data-mdb-ripple-init":"","data-mdb-placement":"top",title:t.errorMessage})},error:function(e){console.error(e)}})}),e.on("click",".tui-select-box-item",function(a){var{columnName:s,rowKey:r}=e.GRID.getFocusedCell(),i=e.updateState({columnName:s,rowKey:r},a.target.dataset.value);let l=e.readState("tables").value,o=e.urlBuilder("validate_field",["table="+l[e.tabIndex].name]);t.ajax({type:"POST",url:o,data:{fieldName:s,value:a.target.dataset.value},success:function(e){i(e.data.isValid,e.data.message)},error:function(e){console.error(e)}})}),e.on("click","#submit_btn_new_record",function(){e.validateForm()&&e.sendDataToServer()}),e.on("input change","#form_new_record input, #form_new_record select",function(){e.validateField(t(this))}),e.on("hide.bs.modal","#basicModal",function(){t(this).find("input").each(function(e){t(this).val("").removeClass(["is-valid","is-invalid"]).siblings(".error-message").text("")})}),window.addEventListener("beforeunload",()=>this.saveStateToLocalStorage()),window.addEventListener("load",()=>this.loadStateFromLocalStorage())}}}}(window,$);



